<extend name="Public:base"/>
<block name="content">
      <div class="content">
      <div class="list-block" style="margin:0">
          <ul>
            <li>
              <div class="item-content">
                <div class="item-media"><i class="icon icon-form-name"></i></div>
                <div class="item-inner">
                  <div class="item-title label">原密码</div>
                  <div class="item-input">
                    <input type="password" placeholder="请输入原密码" id="oldpswd">
                  </div>
                </div>
              </div>
            </li>
            <li>
              <div class="item-content">
                <div class="item-media"><i class="icon icon-form-email"></i></div>
                <div class="item-inner">
                  <div class="item-title label">新密码</div>
                  <div class="item-input">
                    <input type="password" placeholder="请输入新密码" id="passwd">
                  </div>
                </div>
              </div>
            </li>
            <li>
              <div class="item-content">
                <div class="item-media"><i class="icon icon-form-password"></i></div>
                <div class="item-inner">
                  <div class="item-title label">确认密码</div>
                  <div class="item-input">
                    <input type="password" placeholder="请确认密码" id="checkpwd">
                  </div>
                </div>
              </div>
            </li>
          </ul>
  </div>
  <div class="content-block">
    <div class="row">
      <div class="col-100"><a href="#" class="button button-fill button-danger" id="pswd">确认修改</a></div>
    </div>
  </div>
</div>

      </div>

</block>
    <block name="jsinit">
        <div class="popup popup-next">
            <div class="  bar bar-nav   buttons-tab " ><a href="#" class=" title">{$pageInfo['title']}</a></div>
            <div class="content-block row">

                <form action="">
                    <div class="content-padded grid-demo">
                        <div class="row" style="padding:0 0.5rem;">
                            <div id="regtel">
                                <div class="col-100">
                                    <input class="login-input" type="text" name="" id="phone" placeholder="请输入手机号码" value="{$user_info['user_tel']}">
                                </div>
                                <div class="col-100" style="position:relative;">
                                    <input class="login-input" type="text" name="" id="code" placeholder="请输入验证码">
                                    <input class="button button-fill button-success"  style="position:absolute;top:0.1rem;right:0.1rem;height:1.8rem;border-radius:1rem" id="getcode" value="获取验证码" />
                                </div>
                                <div class="col-100">
                                    <input class="button button-fill button-success open-next" type="button" id="next_step" name="" value="下一步" style="height:2rem;margin-bottom:1rem;">
                                </div>
                            </div>

                        </div>

                    </div>
                </form>
            </div>
        </div>
    <script>
        $(".button-link.back").show();
        $(".bar-tab .tab-item").eq(2).addClass('active').siblings().removeClass('active');

        var regsave=true,smssave=false;
        <if condition="empty($user_info['user_tel'])">
            $.popup('.popup-next');
        <else/>regsave=false;
        </if>
        $(document).on('click','#getcode',function () {
            if(smssave)return;
            var $this=$(this);
            var phone = $('#phone').val();
            if(phone==''){
                return $.toast('请先填写手机号！')
            }
            smssave=true;

            $.get('{:U("sms_pswd")}',{phone:phone},function (res) {
                if(res.error==1) {
                    smssave=false;
                    if(res.needlogin==1) location.href="{:U('index/login')}";
                    return $.toast(res.msg);
                } else {
                    $.alert(res.msg);
                    var count = 120;
                    var countdown=setInterval(function () {
                        $this.attr("disabled", true);
                        $this.val("Please wait " + count + " seconds!");
                        if (count == 0) {
                            $this.val("获取验证码").removeAttr("disabled");
                            clearInterval(countdown);
                        }
                        count--;
                    }, 1000);
                }
            })
        });
        var parma={};
        $(document).on('click',"#next_step",function (){
            var phone = $('#phone').val();
            var pattern = /^1[0-9]{10}$/;
            var code=$("#code").val();
            if(code == ""){
                $.toast('验证码不能为空');
                return false;
            }
            if(phone == ""){
                $.toast('手机号不能为空');
                return false;
            }
            if(!pattern.test(phone)){
                $.toast('请输入正确的手机号码');
                return false;
            }
            $.post('{:U("smsreg")}',{phone:phone,code:code},function (res) {
                if(res.error==1) {
                    if(res.needlogin==1) location.href="{:U('index/login')}";
                    return $.toast(res.msg);
                } else {
                    regsave=false;
                    $.alert(res.msg);
                    $.closeModal('.popup.modal-in');
                    parma['phone']=phone;
                    parma['code']=code;
                }
            })
        });

        $(document).on('click',"#pswd",function (){
            if(regsave)return;
            regsave=true;
            var phone = parma['phone'];
            var pattern = /^1[0-9]{10}$/;
            var oldpswd = $("#oldpswd").val(),
                passwd = $("#passwd").val(),
                checkpwd = $("#checkpwd").val();
            if(phone == ""){
                $.toast('手机号不能为空!');
                return false;
            }
            if(!pattern.test(phone)){
                $.toast('请输入正确的手机号码!');
                return false;
            }
            if(passwd!=checkpwd ){
                $.toast('两次输入密码不相同!');
                return false;
            }

            parma['password']=passwd;
            parma['checkpwd']=checkpwd;
            parma['oldpwd']=oldpswd;

            $.post('',parma,function (res) {
                if(res.error==1) {
                    regsave=false;
                    if(res.needlogin==1) location.href="{:U('index/login')}";
                    return $.toast(res.msg);
                } else { regsave=false;
                    $.alert(res.msg);
                    location.href='{:U("user/index")}';

                }
            });
        });

    </script>
    </block>